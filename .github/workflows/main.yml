name: Escaneo de vulnerabilidades

on: push

jobs:
  wpscan:
    runs-on: ubuntu-latest
    steps:
      - name: WPScan
        uses: WTFender/wpscan-action@v1.0
        id: wpscan
        with:
          url: 'https://www.unso.edu.ar'
      - name: Scan Results
        run: |
           echo ${{ steps.wpscan.outputs.result }} > result.json
      - name: Upload Test results
        uses: actions/upload-artifact@master
        with:
           name: Wpscan Report
           path: ${{github.workspace}}/
           
  EngagementDependencyCheck:
          name: Create engagement WPScan
          runs-on: ubuntu-latest
          needs: wpscan
          steps:
            - name: Checkout
              uses: actions/checkout@v2
            - name: SHA-Branch
              id: vars
              shell: bash
              run: |
                    echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
                    echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
            - name: Get current date
              id: date
              run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
            - name: Run the build process with Docker
              uses: addnab/docker-run-action@v3
              with:
                  image: curlimages/curl
                  run: | 
                        curl -X 'POST' \
                        '${{ env.DEFECTDOJO_SERVER }}/api/v2/engagements/' \
                        -H 'accept: application/json' \
                        -H 'Content-Type: application/json' \
                        -H 'X-CSRFTOKEN: tJY9NWtnlqurzkvzn9R4y0uK6TOV5W2gHEU2qllNpdsaQEsd3vC9zrOtpbabmHTZ' \
                        -H "Authorization: Token 7ceb84a28a87cff4088eeefd1e82b843fe5dd50f" \
                        -d '{
                        "name":"WPScan_#${{ steps.vars.outputs.sha_short }}_${{ steps.vars.outputs.branch }}",
                        "engagement_type": "CI/CD",
                        "target_start": "${{ steps.date.outputs.date }}",
                        "target_end": "${{ steps.date.outputs.date }}",
                        "product": 1
                        }'
